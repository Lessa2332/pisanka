<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÑ –†—ñ–∑–¥–≤—è–Ω–∞ –ú–∞–≥—ñ—á–Ω–∞ –ö—É–ª—è</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100%; height: 100%; overflow: hidden;
            background: linear-gradient(45deg, #1e3c72, #2a5298); /* –ì—Ä–∞–¥—ñ—î–Ω—Ç–Ω–∏–π —Ñ–æ–Ω –Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –ø–æ–º–∏–ª–æ–∫ */
            font-family: Arial, sans-serif;
        }
        a-scene {
            position: fixed; top: 0; left: 0;
            width: 100% !important; height: 100% !important;
            background: transparent;
        }
        #sound-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            padding: 12px 24px;
            border: none;
            border-radius: 24px;
            background: linear-gradient(45deg, #00b0ff, #ff00ff);
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <button id="sound-btn">üîä –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫</button>
    <a-scene
        mindar-image="imageTargetSrc: assets/marker.mind; maxTrack: 1; debugMode: true"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        cursor="rayOrigin: mouse"
    >
        <a-assets>
            <audio id="bg-music" src="fon.mp3" preload="auto" loop></audio>
            <!-- Webcam –≤—ñ–¥–µ–æ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø—É -->
            <video id="webcam-video" autoplay playsinline style="display: none;"></video>
        </a-assets>
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <!-- –§–æ–Ω: –í—ñ–¥–µ–æ –∑ –∫–∞–º–µ—Ä–∏ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø—ñ –∞–±–æ –∫–æ–ª—ñ—Ä -->
        <a-sky id="scene-bg" color="#1e3c72"></a-sky>
        <a-entity mindar-image-target="targetIndex: 0">
            <a-sphere
                id="magic-sphere"
                radius="0.8"
                position="0 0 0"
                material="
                    color: #00b0ff;
                    transparent: true;
                    opacity: 0.35;
                    shader: standard;
                    emissive: #0080ff;
                    emissiveIntensity: 0.2;
                    metalness: 0.1;
                    roughness: 0.3;
                    side: double
                "
                visible="true" <!-- –ó–∞–≤–∂–¥–∏ –≤–∏–¥–Ω–æ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø—ñ -->
            >
                <a-animation
                    attribute="rotation"
                    to="0 360 0"
                    dur="10000"
                    repeat="indefinite"
                ></a-animation>
                <a-entity id="sparkle-light" light="type: point; intensity: 0; color: #FFD700" position="0 0 0"></a-entity>
            </a-sphere>
            <a-entity id="particles" particle-system="
                preset: dust;
                color: #FFD700,#FF00FF,#00B0FF;
                particleCount: 200;
                velocityValue: 0 0 0;
                velocitySpread: 2 2 2;
                accelerationValue: 0 -9.8 0;
                accelerationSpread: 0 0 0;
                startSize: 0.05;
                endSize: 0.01;
                startOpacity: 1;
                endOpacity: 0;
                duration: 3;
                opacity: 0;
            " position="0 0 0" visible="false"></a-entity>
            <!-- –¢–µ—Å—Ç-—Ç–µ–∫—Å—Ç: –ü–æ–∫–∞–∑—É—î—Ç—å—Å—è —Å–ø–æ—á–∞—Ç–∫—É –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø—ñ, –∑–Ω–∏–∫–∞—î –ø—ñ—Å–ª—è –∫–ª—ñ–∫—É -->
            <a-text
                id="test-text"
                value="–ö–ª—ñ–∫–Ω—ñ—Ç—å –±—É–¥—å-–¥–µ –¥–ª—è –ø—Ä–æ—Ä–æ—Ü—Ç–≤–∞! (–¢–µ—Å—Ç)"
                position="0 1.5 -2"
                color="#FFD700"
                width="4"
                align="center"
                font="kelsonsans"
                visible="false" <!-- –•–æ–≤–∞—î–º–æ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É -->
            ></a-text>
        </a-entity>
        <!-- –õ–æ–∞–¥–µ—Ä —Ç—ñ–ª—å–∫–∏ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ -->
        <a-entity id="loader" position="0 0 -2" visible="true">
            <a-plane width="3" height="1.5" color="#0a0f2c" opacity="0.8" side="double"></a-plane>
            <a-text value="–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä!\n(–ú–æ–±—ñ–ª—å–Ω–∏–π + HTTPS)" align="center" color="#00b0ff" width="2.8" position="0 0 0.01" font="kelsonsans"></a-text>
        </a-entity>
    </a-scene>
    <script>
        const bgMusic = document.getElementById('bg-music');
        const loader = document.getElementById('loader');
        const sphere = document.getElementById('magic-sphere');
        const sparkleLight = document.getElementById('sparkle-light');
        const particles = document.getElementById('particles');
        const soundBtn = document.getElementById('sound-btn');
        const webcamVideo = document.getElementById('webcam-video');
        const sceneBg = document.getElementById('scene-bg');
        const testText = document.getElementById('test-text');
        const scene = document.querySelector('a-scene');
        let isTargetActive = false;
        let isMobileAR = false;
        let prophecyActive = false; // –î–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è —Å–ø–∞–º—É
        
        const prophecies = [
            "–©–∞—Å–ª–∏–≤–æ–≥–æ –†—ñ–∑–¥–≤–∞!",
            "–ë–∞–∂–∞—é –¥–∏–≤–∞ –≤ –ù–æ–≤–æ–º—É —Ä–æ—Ü—ñ!",
            "–ù–µ—Ö–∞–π –º—Ä—ñ—ó –∑–±—É–≤–∞—é—Ç—å—Å—è!",
            "–õ—é–±–æ–≤ —ñ —Ç–µ–ø–ª–æ —É —Ç–≤–æ—î–º—É –¥–æ–º—ñ!",
            "–ú–∞–≥—ñ—è –≤—ñ—Ä–∏—Ç—å —É —Ç–µ–±–µ! ‚ú®"
        ];

        // –í–∏—è–≤–ª–µ–Ω–Ω—è –¥–µ—Å–∫—Ç–æ–ø—É
        isMobileAR = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (!isMobileAR) {
            console.log("üñ•Ô∏è –î–µ—Å–∫—Ç–æ–ø: –£–≤—ñ–º–∫–Ω–µ–Ω–æ webcam + fallback");
            loader.setAttribute('visible', 'false');
            sphere.setAttribute('visible', 'true');
            testText.setAttribute('visible', 'true'); // –ü–æ–∫–∞–∑—É—î–º–æ —Ç–µ—Å—Ç-—Ç–µ–∫—Å—Ç
            isTargetActive = true;

            // –ó–∞–ø–∏—Ç –≤–µ–±-–∫–∞–º–µ—Ä–∏ –¥–ª—è —Ñ–æ–Ω—É
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                .then(stream => {
                    webcamVideo.srcObject = stream;
                    webcamVideo.onloadedmetadata = () => {
                        // –í—ñ–¥–µ–æ —è–∫ —Ñ–æ–Ω —Å—Ü–µ–Ω–∏
                        sceneBg.setAttribute('material', 'src: #webcam-video; shader: flat; side: back');
                        console.log("‚úÖ Webcam –∞–∫—Ç–∏–≤–Ω–∞ —è–∫ —Ñ–æ–Ω!");
                    };
                })
                .catch(err => {
                    console.warn("‚ö†Ô∏è Webcam –Ω–µ –¥–æ–∑–≤–æ–ª–µ–Ω–∞ ‚Äî –≥—Ä–∞–¥—ñ—î–Ω—Ç–Ω–∏–π —Ñ–æ–Ω:", err);
                    sceneBg.setAttribute('color', '#1e3c72'); // Fallback –∫–æ–ª—ñ—Ä
                });
        }

        // –ö–Ω–æ–ø–∫–∞ –∑–≤—É–∫—É
        soundBtn.addEventListener('click', () => {
            if (bgMusic.paused) {
                bgMusic.play().catch(e => console.log("üîá Audio failed:", e));
                soundBtn.textContent = 'üîä –í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫';
            } else {
                bgMusic.pause();
                soundBtn.textContent = 'üîä –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫';
            }
        });

        // –§—É–Ω–∫—Ü—ñ—è –ø—Ä–æ—Ä–æ—Ü—Ç–≤–∞
        function showProphecy() {
            if (prophecyActive) return; // –£–Ω–∏–∫–∞—î–º–æ —Å–ø–∞–º—É
            prophecyActive = true;
            console.log("‚ú® showProphecy –≤–∏–∫–ª–∏–∫–∞–Ω–æ!");

            const parent = sphere.parentNode;
            if (!parent) return;

            // –•–æ–≤–∞—î–º–æ —Ç–µ—Å—Ç-—Ç–µ–∫—Å—Ç
            testText.setAttribute('visible', 'false');

            const message = prophecies[Math.floor(Math.random() * prophecies.length)];
            [...parent.querySelectorAll('[data-prophecy]')].forEach(el => el.remove());

            const text = document.createElement('a-text');
            text.setAttribute('value', message);
            text.setAttribute('position', '0 0 0.9');
            text.setAttribute('color', '#FFD700');
            text.setAttribute('width', '3.5');
            text.setAttribute('align', 'center');
            text.setAttribute('font', 'kelsonsans');
            text.setAttribute('opacity', '0');
            text.setAttribute('animation__fadein', 
                'property: opacity; from: 0; to: 1; dur: 1500; easing: easeOutCubic; startEvents: startFadeIn'
            );
            text.setAttribute('animation__pulse', 
                'property: color; from: #FFD700; to: #FF4500; dir: alternate; dur: 500; repeat: 4; startEvents: startFadeIn'
            );
            text.setAttribute('data-prophecy', 'true');
            text.setAttribute('side', 'double');

            parent.appendChild(text);

            // –ï—Ñ–µ–∫—Ç–∏
            particles.setAttribute('visible', 'true');
            particles.setAttribute('animation__particles', 'property: opacity; from: 0; to: 1; dur: 500; startEvents: startParticles');
            particles.emit('startParticles');
            sparkleLight.setAttribute('light: intensity', '1');
            setTimeout(() => sparkleLight.setAttribute('light: intensity', '0'), 2000);
            if (bgMusic.paused) bgMusic.play().catch(e => console.log("üîá BG:", e));

            setTimeout(() => {
                if (text.parentNode) text.emit('startFadeIn');
            }, 200);

            setTimeout(() => {
                if (text.parentNode) {
                    text.setAttribute('animation__fadeout', 'property: opacity; to: 0; dur: 1000; startEvents: startFadeOut');
                    text.emit('startFadeOut');
                    setTimeout(() => { if (text.parentNode) text.parentNode.removeChild(text); }, 1000);
                }
                setTimeout(() => {
                    particles.setAttribute('visible', 'false');
                    particles.setAttribute('animation__particles', null);
                    prophecyActive = false; // –î–æ–∑–≤–æ–ª—è—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω–µ
                }, 1000);
            }, 5000);
        }

        // MindAR –ø–æ–¥—ñ—ó (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ)
        const target = document.querySelector('[mindar-image-target]');
        if (target && isMobileAR) {
            scene.addEventListener('renderstart', () => {
                console.log("üé• MindAR —Å—Ç–∞—Ä—Ç—É—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É");
            });
            target.addEventListener('targetFound', () => {
                isTargetActive = true;
                loader.setAttribute('visible', 'false');
                sphere.setAttribute('visible', 'true');
                testText.setAttribute('visible', 'false');
                console.log("‚úÖ –ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ!");
            });
            target.addEventListener('targetLost', () => {
                isTargetActive = false;
                loader.setAttribute('visible', 'true');
                sphere.setAttribute('visible', 'false');
                [...document.querySelectorAll('[data-prophecy]')].forEach(el => el.remove());
                particles.setAttribute('visible', 'false');
                sparkleLight.setAttribute('light: intensity', '0');
                console.log("‚ùå –ú–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ");
            });
        }

        // –ö–ª—ñ–∫ –ø–æ –∫—É–ª—ñ (–¥–æ–¥–∞—Ç–∫–æ–≤–æ)
        sphere.addEventListener('click', (evt) => {
            if (isTargetActive || !isMobileAR) {
                evt.preventDefault();
                showProphecy();
            }
        });

        // –ö–ª—ñ–∫/—Ç–∞—á –ø–æ –≤—Å—å–æ–º—É –µ–∫—Ä–∞–Ω—É (fallback –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø—É/–º–æ–±—ñ–ª—å–Ω–æ–≥–æ)
        document.body.addEventListener('click', (e) => {
            if (!e.target.closest('#sound-btn') && (isTargetActive || !isMobileAR)) {
                e.preventDefault();
                showProp Prophecy();
            }
        });
        document.body.addEventListener('touchstart', (e) => {
            if (!e.target.closest('#sound-btn') && (isTargetActive || !isMobileAR)) {
                e.preventDefault();
                showProphecy();
            }
        }, { passive: false });
    </script>
</body>
</html>
